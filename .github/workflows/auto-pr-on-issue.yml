name: Auto PR on Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    # Only run if the issue title starts with "auto" (case-insensitive)
    if: startsWith(github.event.issue.title, 'auto')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Extract issue metadata
        id: issue
        run: |
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")

          # Sanitize title for branch name: replace whitespace with dashes, restrict to alnum, dash, underscore, dot, slash
          SANITIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[[:space:]]/-/g' | sed 's/[^a-z0-9._/-]//g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)

          BRANCH_NAME="auto/${SANITIZED_TITLE}-${ISSUE_NUMBER}"

          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

          # Store body to a secure temp file to preserve multiline content
          BODY_FILE=$(mktemp)
          echo "$ISSUE_BODY" > "$BODY_FILE"
          echo "body_file=$BODY_FILE" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Create implementation task file
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BODY_FILE: ${{ steps.issue.outputs.body_file }}
        run: |
          mkdir -p .github/auto-fix

          cat > ".github/auto-fix/${ISSUE_NUMBER}-TASK.md" << EOF
          # Auto-Implementation Task

          ## Issue Details

          - **Issue Number:** #${ISSUE_NUMBER}
          - **Issue Title:** ${ISSUE_TITLE}

          ## Issue Description

          EOF

          # Append issue body preserving content
          cat "$BODY_FILE" >> ".github/auto-fix/${ISSUE_NUMBER}-TASK.md"

          cat >> ".github/auto-fix/${ISSUE_NUMBER}-TASK.md" << 'EOF'

          ## Implementation Instructions

          This file serves as input for automated code implementation.
          The GitHub Copilot Workspace or AI agent should:

          1. Analyze the issue requirements thoroughly
          2. Understand the existing codebase context
          3. Implement the necessary code changes
          4. Ensure code follows existing patterns and conventions
          5. Add or update tests if applicable
          6. Update documentation if needed

          ## Repository Context

          - **Primary Language:** C#
          - **Framework:** .NET
          - **Purpose:** DTO to Dart class generator
          - **Key Files:** Program.cs, DtoToDartGenerator.csproj

          ---
          *This task file was automatically generated for AI-powered implementation.*
          EOF

      - name: Trigger Copilot Workspace Implementation
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BODY_FILE: ${{ steps.issue.outputs.body_file }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a Copilot Workspace session using GitHub CLI
          # This attempts to use GitHub Copilot to implement the issue
          
          echo "Attempting to trigger Copilot Workspace implementation..."
          
          # Install GitHub CLI extensions if needed
          if ! gh extension list | grep -q copilot; then
            echo "Installing GitHub Copilot CLI extension..."
            gh extension install github/gh-copilot || echo "Copilot extension not available or already installed"
          fi
          
          # Create implementation context file
          cat > /tmp/copilot-task.txt << EOF
          Implement the following GitHub issue:
          
          Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}
          
          $(cat "$BODY_FILE")
          
          Please analyze the codebase, understand the requirements, and implement the necessary changes.
          EOF
          
          echo "Copilot Workspace URL: https://copilot-workspace.githubnext.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"
          echo "Manual intervention may be needed if automated implementation is not available."
          
          # Note: Direct API for Copilot Workspace implementation is in private beta
          # This step prepares the context and documents the workspace URL for manual triggering if needed

      - name: Analyze codebase for implementation
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BODY_FILE: ${{ steps.issue.outputs.body_file }}
        run: |
          echo "Analyzing repository structure for implementation context..."
          
          # Create a context file for AI implementation
          mkdir -p .github/auto-fix
          
          cat > ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md" << 'EOF_CONTEXT'
          # Repository Context for AI Implementation
          
          ## File Structure
          EOF_CONTEXT
          
          # Add repository tree (limited depth)
          tree -L 2 -I 'bin|obj|node_modules' . >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md" 2>/dev/null || \
          find . -maxdepth 2 -type f -not -path '*/\.*' | head -20 >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          
          echo "" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          echo "## Key Files" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          echo "" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          
          # List key project files
          if [ -f "Program.cs" ]; then
            echo "- Program.cs (main entry point)" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          fi
          if [ -f "DtoToDartGenerator.csproj" ]; then
            echo "- DtoToDartGenerator.csproj (project configuration)" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          fi
          if [ -f "README.md" ]; then
            echo "- README.md (documentation)" >> ".github/auto-fix/${ISSUE_NUMBER}-CONTEXT.md"
          fi

      - name: Attempt AI implementation
        id: ai_implementation
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BODY_FILE: ${{ steps.issue.outputs.body_file }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: Add AI API keys here for automatic implementation
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "=== AI Implementation Attempt ==="
          echo "Issue: #${ISSUE_NUMBER} - ${ISSUE_TITLE}"
          echo ""
          
          # Read the issue body
          ISSUE_BODY=$(cat "$BODY_FILE")
          
          # Check if AI implementation is available
          AI_AVAILABLE=false
          
          # Option 1: Try GitHub Copilot CLI
          if command -v gh >/dev/null 2>&1; then
            echo "GitHub CLI available, checking for Copilot extension..."
            if gh extension list 2>/dev/null | grep -q copilot; then
              echo "Copilot extension found!"
              AI_AVAILABLE=true
            else
              echo "Copilot extension not installed. Install with: gh extension install github/gh-copilot"
            fi
          fi
          
          # Option 2: Check for AI API keys
          if [ -n "${OPENAI_API_KEY:-}" ] || [ -n "${ANTHROPIC_API_KEY:-}" ]; then
            echo "AI API keys detected, could enable automatic implementation"
            echo "Note: Actual implementation requires additional integration code"
          fi
          
          # For now, create a marker that implementation was attempted
          if [ "$AI_AVAILABLE" = "true" ]; then
            echo "AI implementation capability detected"
            echo "implemented=partial" >> "$GITHUB_OUTPUT"
          else
            echo "No AI implementation capability available"
            echo "This workflow can be extended with:"
            echo "1. GitHub Copilot CLI (gh copilot)"
            echo "2. OpenAI/Anthropic API integration"
            echo "3. Custom AI coding agent"
            echo ""
            echo "implemented=manual_needed" >> "$GITHUB_OUTPUT"
          fi
          
          echo ""
          echo "ðŸ“ For AI-powered implementation, use GitHub Copilot Workspace:"
          echo "   https://copilot-workspace.githubnext.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"
          echo ""
          echo "Or enable automatic implementation by:"
          echo "1. Adding AI API keys to repository secrets"
          echo "2. Extending this workflow with AI integration"
          
      - name: Create AI implementation guide
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
        run: |
          mkdir -p .github/auto-fix
          
          cat > ".github/auto-fix/${ISSUE_NUMBER}-IMPLEMENTATION-GUIDE.md" << 'EOF'
          # AI Implementation Guide
          
          ## Automatic Implementation Options
          
          This workflow can be enhanced to automatically implement issues using AI. Here are the integration options:
          
          ### Option 1: GitHub Copilot Workspace (Easiest - RECOMMENDED)
          
          Use GitHub Copilot Workspace to automatically analyze and implement issues:
          
          1. Open the issue in Copilot Workspace using the URL in the PR description
          2. Copilot will analyze the issue and propose changes
          3. Review and accept the changes
          4. Changes will be automatically committed to this PR
          
          **This is the official GitHub solution for AI-powered issue implementation.**
          
          ### Option 2: GitHub Copilot CLI Integration
          
          Add GitHub Copilot CLI support to this workflow:
          
          ```yaml
          - name: Implement with Copilot
            run: |
              gh extension install github/gh-copilot
              # Use gh copilot to suggest implementation
          ```
          
          ### Option 3: AI API Integration
          
          Integrate with OpenAI, Anthropic, or other AI APIs:
          
          1. Add API keys to repository secrets (OPENAI_API_KEY, ANTHROPIC_API_KEY)
          2. Create a script that:
             - Reads the issue description
             - Analyzes the codebase
             - Generates code changes
             - Commits the changes
          
          ### Option 4: Third-Party AI Coding Agents
          
          Use existing GitHub Actions for AI code generation:
          - Mentat AI
          - Aider
          - Other AI coding tools with GitHub Actions support
          
          ## Current Status
          
          Currently, this workflow prepares comprehensive context and task files for AI implementation.
          The PR is created with the `copilot:all` label to enable GitHub Copilot integration.
          
          For automatic implementation:
          - Use GitHub Copilot Workspace (link in PR description)
          - Or extend this workflow with custom AI integration
          EOF
          
          echo "Created implementation guide at .github/auto-fix/${ISSUE_NUMBER}-IMPLEMENTATION-GUIDE.md"
      
      - name: Post comment with Copilot Workspace link
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.issue.outputs.issue_number }}';
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            const repo = context.repo;
            
            const comment = `## ðŸ¤– AI Implementation Ready
            
            This PR is ready for AI-powered implementation!
            
            ### Quick Start: Use GitHub Copilot Workspace
            
            Click here to automatically implement this issue with AI:
            
            **ðŸ‘‰ [Implement with Copilot Workspace](https://copilot-workspace.githubnext.com/${repo.owner}/${repo.repo}/issues/${issueNumber})**
            
            Copilot Workspace will:
            âœ… Analyze the issue and codebase
            âœ… Generate implementation code
            âœ… Create commits automatically
            âœ… Sync changes to this PR
            
            ---
            
            ### Alternative: GitHub Copilot for Pull Requests
            
            GitHub Copilot may also provide inline code suggestions in this PR.
            Look for Copilot's suggestions in the comments below.
            
            ---
            
            *Need help? Check the [Implementation Guide](.github/auto-fix/${issueNumber}-IMPLEMENTATION-GUIDE.md)*`;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Append to CHANGELOG.log
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BRANCH_NAME: ${{ steps.issue.outputs.branch_name }}
        run: |
          mkdir -p .github/auto-fix

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "[${TIMESTAMP}] Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE} - Branch: ${BRANCH_NAME}" >> .github/auto-fix/CHANGELOG.log

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.issue.outputs.branch_name }}
          base: master
          commit-message: "Auto-implementation: preparing AI-powered fix for issue #${{ steps.issue.outputs.issue_number }}"
          title: "Auto-fix: ${{ steps.issue.outputs.issue_title }}"
          labels: |
            auto-fix
            copilot:all
          body: |
            ## ðŸ¤– Auto-Implementation Pull Request

            This PR was automatically created for AI-powered implementation of issue #${{ steps.issue.outputs.issue_number }}.

            ### ðŸ“‹ Issue Details

            **Title:** ${{ steps.issue.outputs.issue_title }}

            **Description:**
            ${{ github.event.issue.body }}

            ### ðŸ”§ Implementation Files Created

            - âœ… [Implementation Task](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-TASK.md) - Detailed requirements
            - âœ… [Repository Context](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-CONTEXT.md) - Codebase structure
            - âœ… [Implementation Guide](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-IMPLEMENTATION-GUIDE.md) - AI integration options
            - âœ… [Changelog](.github/auto-fix/CHANGELOG.log) - Activity log

            ### ðŸš€ Implementation Options

            #### Option 1: GitHub Copilot Workspace (Recommended - Opens in new UI)
            
            Click to open in GitHub Copilot Workspace for AI-powered automatic implementation:
            
            **ðŸ‘‰ [Open in Copilot Workspace](https://copilot-workspace.githubnext.com/${{ github.repository }}/issues/${{ steps.issue.outputs.issue_number }})**
            
            Copilot Workspace will:
            - Analyze the issue requirements
            - Understand the codebase context
            - Generate implementation code
            - Create commits automatically
            - Sync changes back to this PR

            #### Option 2: GitHub Copilot for Pull Requests (Automatic suggestions in comments)
            
            This PR is labeled with `copilot:all` to enable GitHub Copilot to provide code suggestions.
            - Copilot will analyze the issue and suggest implementations in PR comments
            - Review and apply the suggestions as they appear
            
            #### Option 3: Manual Implementation
            
            1. Review the [task file](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-TASK.md)
            2. Review the [context file](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-CONTEXT.md)
            3. Implement changes locally or via web editor
            4. Push commits to the `${{ steps.issue.outputs.branch_name }}` branch
            5. Mark PR as ready for review when complete

            ### ðŸ’¡ For Repository Maintainers

            To enable fully automatic implementation:
            1. Add AI API keys to repository secrets (optional)
            2. Extend the workflow with AI integration
            3. See [Implementation Guide](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-IMPLEMENTATION-GUIDE.md)

            ### ðŸŽ¯ Expected Outcome

            When implementation is complete, this PR should contain code changes that:
            - Fully address the requirements in issue #${{ steps.issue.outputs.issue_number }}
            - Follow existing code patterns and conventions
            - Include tests if applicable
            - Update documentation if needed

            ---
            **Closes #${{ steps.issue.outputs.issue_number }}**
            
            *ðŸ¤– This PR was automatically generated. Use GitHub Copilot Workspace for automatic implementation.*
          draft: false
          delete-branch: false
