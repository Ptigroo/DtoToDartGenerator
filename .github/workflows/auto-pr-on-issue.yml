name: Auto PR on Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  auto-fix:
    # Only run if the issue title starts with "auto" (case-insensitive)
    if: startsWith(github.event.issue.title, 'auto')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Extract issue metadata
        id: issue
        run: |
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")

          # Sanitize title for branch name: replace whitespace with dashes, restrict to alnum, dash, underscore, dot, slash
          SANITIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[[:space:]]/-/g' | sed 's/[^a-z0-9._/-]//g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)

          BRANCH_NAME="auto/${SANITIZED_TITLE}-${ISSUE_NUMBER}"

          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

          # Store body to a secure temp file to preserve multiline content
          BODY_FILE=$(mktemp)
          echo "$ISSUE_BODY" > "$BODY_FILE"
          echo "body_file=$BODY_FILE" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create working branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${{ steps.issue.outputs.branch_name }}"

      - name: Create plan file
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BODY_FILE: ${{ steps.issue.outputs.body_file }}
        run: |
          mkdir -p .github/auto-fix

          cat > ".github/auto-fix/${ISSUE_NUMBER}-PLAN.md" << EOF
          # Auto-Fix Plan

          ## Issue Details

          - **Issue Number:** #${ISSUE_NUMBER}
          - **Issue Title:** ${ISSUE_TITLE}

          ## Issue Body

          EOF

          # Append issue body preserving content
          cat "$BODY_FILE" >> ".github/auto-fix/${ISSUE_NUMBER}-PLAN.md"

          cat >> ".github/auto-fix/${ISSUE_NUMBER}-PLAN.md" << 'EOF'

          ## Proposed Actions

          1. Review the issue requirements
          2. Implement necessary changes
          3. Test the changes
          4. Update documentation if needed

          ## Status

          - [ ] Plan reviewed
          - [ ] Changes implemented
          - [ ] Tests passed
          - [ ] Ready for review

          ---
          *This plan was automatically generated by the auto-fix workflow.*
          EOF

      - name: Merge config defaults
        run: |
          # Merge defaults from dto-to-dart.config.json.template into dto-to-dart.config.json
          # Existing config values take precedence
          if [ -f "dto-to-dart.config.json.template" ] && [ -f "dto-to-dart.config.json" ]; then
            node -e "
              const fs = require('fs');
              const template = JSON.parse(fs.readFileSync('dto-to-dart.config.json.template', 'utf8'));
              const config = JSON.parse(fs.readFileSync('dto-to-dart.config.json', 'utf8'));
              // Merge: template provides defaults, config values take precedence
              const merged = { ...template, ...config };
              fs.writeFileSync('dto-to-dart.config.json', JSON.stringify(merged, null, 2) + '\n');
              console.log('Merged config with template defaults');
            "
          else
            echo "Skipping config merge: required files not found"
          fi

      - name: Append marker to Program.cs
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
        run: |
          if [ -f "Program.cs" ]; then
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            echo "" >> Program.cs
            echo "// Auto-fix marker: Issue #${ISSUE_NUMBER} - ${ISSUE_TITLE} (${TIMESTAMP})" >> Program.cs
            echo "Added marker comment to Program.cs"
          else
            echo "Skipping marker: Program.cs not found"
          fi

      - name: Append to CHANGELOG.log
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.issue_title }}
          BRANCH_NAME: ${{ steps.issue.outputs.branch_name }}
        run: |
          mkdir -p .github/auto-fix

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "[${TIMESTAMP}] Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE} - Branch: ${BRANCH_NAME}" >> .github/auto-fix/CHANGELOG.log

      - name: Commit changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-fix: scaffold for issue #${{ steps.issue.outputs.issue_number }}"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.issue.outputs.branch_name }}
          base: master
          title: "Auto-fix: ${{ steps.issue.outputs.issue_title }}"
          body: |
            ## Auto-Generated Pull Request

            This PR was automatically created in response to issue #${{ steps.issue.outputs.issue_number }}.

            ### Issue Details

            **Title:** ${{ steps.issue.outputs.issue_title }}

            **Body:**
            ${{ github.event.issue.body }}

            ### Changes Made

            - Created plan file at `.github/auto-fix/${{ steps.issue.outputs.issue_number }}-PLAN.md`
            - Merged config defaults (if applicable)
            - Added marker comment to `Program.cs` (if applicable)
            - Updated `.github/auto-fix/CHANGELOG.log`

            ### Next Steps

            1. Review the [plan file](.github/auto-fix/${{ steps.issue.outputs.issue_number }}-PLAN.md)
            2. AI or developers can push additional commits to implement the fix
            3. Review and merge when ready

            ---
            *Closes #${{ steps.issue.outputs.issue_number }}*
          draft: true
          delete-branch: false
